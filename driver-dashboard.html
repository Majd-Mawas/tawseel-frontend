<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Driver Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Yesteryear&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="./css/home.css"
    />
    <!-- Leaflet CSS and JS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine for route calculation -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"
    />
    <style>
      .dashboard-container {
        display: flex;
        flex-direction: column;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .dashboard-title {
        font-size: 24px;
        font-weight: bold;
      }

      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-bottom: none;
        border-radius: 5px 5px 0 0;
        margin-right: 5px;
      }

      .tab.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .order-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .order-card {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .order-card h3 {
        margin-top: 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }

      .order-details {
        margin-bottom: 15px;
      }

      .order-detail {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
      }

      .order-actions {
        display: flex;
        justify-content: flex-end;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background-color: #0069d9;
      }

      .btn-success {
        background-color: #28a745;
        color: white;
      }

      .btn-success:hover {
        background-color: #218838;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        position: relative;
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 8px;
        width: 80%;
        max-width: 900px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .close-modal {
        position: absolute;
        right: 15px;
        top: 10px;
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close-modal:hover,
      .close-modal:focus {
        color: black;
        text-decoration: none;
      }

      .modal-header {
        padding-bottom: 10px;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .map-container {
        height: 500px;
        border-radius: 5px;
        overflow: hidden;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      .order-items {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed #eee;
      }

      .order-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 14px;
      }

      .no-orders {
        text-align: center;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 5px;
        color: #6c757d;
      }
    </style>
  </head>

  <body>
    <header style="background-color: black">
      <nav>
        <div class="logo">
          <h1 class="logo">Tawseel</h1>
        </div>
        <ul>
          <li><a href="driver-dashboard.html" class="active">DASHBOARD</a></li>
          <!-- <li><a href="#" id="profile-link">PROFILE</a></li> -->
        </ul>
        <a href="index.html" class="button" id="logout-btn">LOG OUT</a>
      </nav>
    </header>

    <div class="dashboard-container">
      <div class="dashboard-header">
        <div class="dashboard-title">Driver Dashboard</div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="available-orders">
          Available Orders
        </div>
        <div class="tab" data-tab="assigned-orders">My Assigned Orders</div>
      </div>

      <div class="tab-content active" id="available-orders">
        <div class="order-list" id="available-orders-list">
          <!-- Available orders will be loaded here -->
          <div class="no-orders">Loading available orders...</div>
        </div>
      </div>

      <div class="tab-content" id="assigned-orders">
        <div class="order-list" id="assigned-orders-list">
          <!-- Assigned orders will be loaded here -->
          <div class="no-orders">Loading your assigned orders...</div>
        </div>
      </div>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div class="modal-header">
          <h3 id="mapModalTitle">Order Route</h3>
        </div>
        <div class="map-container" id="mapContainer">
          <div id="map"></div>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-1">
        <div class="footer-1-1">
          <h2 class="logo">Tawseel</h2>
          <p class="p3">
            Fast and reliable delivery service for all your needs.
          </p>
        </div>
        <div class="footer-1-1">
          <h3>Quick links</h3>
          <div class="li-footer">
            <li><a href="driver-dashboard.html">Dashboard</a></li>
            <!-- <li><a href="#">Profile</a></li> -->
            <!-- <li><a href="#">Help</a></li> -->
          </div>
        </div>
        <div class="footer-1-1">
          <h3>follow us:</h3>
          <div class="icon-footer">
            <a href="">
              <i
                class="fa2 fa fa-facebook-square"
                style="font-size: 15px; color: #bf8208"
              ></i>
            </a>
            <a href="">
              <i
                class="fa2 fa fa-instagram"
                style="font-size: 15px; color: #bf8208"
              ></i>
            </a>
            <a href="">
              <i
                class="fa2 fa fa-twitter"
                style="font-size: 15px; color: #bf8208"
              ></i>
            </a>
          </div>
        </div>
      </div>
      <hr />
      <p class="p4">
        Copyright<i style="font-size: 15px" class="fa">&#xf1f9;</i> 2025 Tawseel
      </p>
    </footer>

    <script>
      const url = "https://tawseel.circleteams.com";
      // const url = "http://tawseel.test";

      // Check if user is logged in and is a driver
      document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        const userRole = localStorage.getItem("userRole");

        if (!token || userRole !== "driver") {
          window.location.href = "signin.html";
          return;
        }

        // Initialize the dashboard
        loadAvailableOrders();
        loadAssignedOrders();

        // Set up tab switching
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            document
              .querySelectorAll(".tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".tab-content")
              .forEach((c) => c.classList.remove("active"));

            this.classList.add("active");
            document.getElementById(this.dataset.tab).classList.add("active");
          });
        });

        // Set up logout
        document
          .getElementById("logout-btn")
          .addEventListener("click", function () {
            localStorage.removeItem("token");
            localStorage.removeItem("userRole");
            window.location.href = "index.html";
          });

        // Set up modal close button
        document
          .querySelector(".close-modal")
          .addEventListener("click", function () {
            document.getElementById("mapModal").style.display = "none";
          });

        // Close modal when clicking outside of it
        window.addEventListener("click", function (event) {
          const modal = document.getElementById("mapModal");
          if (event.target === modal) {
            modal.style.display = "none";
          }
        });
      });

      // Load available orders
      async function loadAvailableOrders() {
        try {
          const response = await fetch(`${url}/api/driver/orders/available`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            displayOrders(data.data, "available-orders-list", true);
          } else {
            document.getElementById("available-orders-list").innerHTML =
              '<div class="no-orders">Failed to load available orders. Please try again.</div>';
          }
        } catch (error) {
          console.error("Error loading available orders:", error);
          document.getElementById("available-orders-list").innerHTML =
            '<div class="no-orders">Error loading orders. Please check your connection.</div>';
        }
      }

      // Load assigned orders
      async function loadAssignedOrders() {
        try {
          const response = await fetch(`${url}/api/driver/orders/assigned`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            displayOrders(data.data, "assigned-orders-list", false);
          } else {
            document.getElementById("assigned-orders-list").innerHTML =
              '<div class="no-orders">Failed to load your assigned orders. Please try again.</div>';
          }
        } catch (error) {
          console.error("Error loading assigned orders:", error);
          document.getElementById("assigned-orders-list").innerHTML =
            '<div class="no-orders">Error loading orders. Please check your connection.</div>';
        }
      }

      // Display orders in the specified container
      function displayOrders(orders, containerId, isAvailable) {
        const container = document.getElementById(containerId);

        if (!orders || orders.length === 0) {
          container.innerHTML = `<div class="no-orders">No ${
            isAvailable ? "available" : "assigned"
          } orders found.</div>`;
          return;
        }

        let html = "";

        orders.forEach((order) => {
          html += `
              <div class="order-card" data-order-id="${order.id}">
                <h3>Order #${order.id}</h3>
                <div class="order-details">
                  <div class="order-detail">
                    <span>Restaurant:</span>
                    <span>${
                      order.restaurant ? order.restaurant.name : "N/A"
                    }</span>
                  </div>
                  <div class="order-detail">
                    <span>Total:</span>
                    <span>$${((order.total_price || 0) / 100).toFixed(2)}</span>
                  </div>
                  <div class="order-detail">
                    <span>Delivery Fee:</span>
                    <span>$${((order.delivery_fee || 0) / 100).toFixed(
                      2
                    )}</span>
                  </div>
                  <div class="order-detail">
                    <span>Status:</span>
                    <span>${order.status || "Pending"}</span>
                  </div>
                  <div class="order-detail">
                    <span>Created:</span>
                    <span>${new Date(order.created_at).toLocaleString()}</span>
                  </div>
                </div>
                <div class="order-items">
                  <strong>Items:</strong>
                  ${
                    order.items
                      ? order.items
                          .map(
                            (item) => `
                      <div class="order-item">
                        <span>${
                          item.meal ? item.meal.name : "Unknown Item"
                        }</span>
                        <span>x${item.quantity}</span>
                      </div>
                    `
                          )
                          .join("")
                      : "<div>No items</div>"
                  }
                </div>
                <div class="order-actions">
                  ${
                    isAvailable
                      ? `<button class="btn btn-primary assign-btn" style="margin-inline:0.7rem;" data-order-id="${order.id}">Assign to Me</button>
                         <button class="btn btn-success view-map-btn" data-order-id="${order.id}">View Map</button>`
                      : `<button class="btn btn-success view-map-btn" data-order-id="${order.id}">View Map</button>`
                  }
                </div>
              </div>
            `;
        });

        container.innerHTML = html;

        // Add event listeners to buttons
        if (isAvailable) {
          document.querySelectorAll(".assign-btn").forEach((btn) => {
            btn.addEventListener("click", function () {
              assignOrder(this.dataset.orderId);
            });
          });
        }

        // Add event listeners to view map buttons for both available and assigned orders
        document.querySelectorAll(".view-map-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            viewOrderMap(this.dataset.orderId);
          });
        });
      }

      // Assign order to the current driver
      async function assignOrder(orderId) {
        try {
          const response = await fetch(`${url}/api/driver/orders/assign`, {
            method: "POST",
            body: JSON.stringify({
              order_id: orderId,
            }),
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            alert("Order assigned successfully!");
            // Refresh both order lists
            loadAvailableOrders();
            loadAssignedOrders();
          } else {
            const errorData = await response.json();
            alert(
              `Failed to assign order: ${errorData.message || "Unknown error"}`
            );
          }
        } catch (error) {
          console.error("Error assigning order:", error);
          alert("Error assigning order. Please try again.");
        }
      }

      // View order on map
      async function viewOrderMap(orderId) {
        try {
          const response = await fetch(`${url}/api/driver/orders/${orderId}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            const order = data.data;

            if (
              !order.restaurant ||
              !order.restaurant.latitude ||
              !order.restaurant.longitude ||
              !order.latitude ||
              !order.longitude
            ) {
              alert("Cannot display map: Missing location information");
              return;
            }

            // Set modal title
            document.getElementById(
              "mapModalTitle"
            ).textContent = `Order #${order.id} Route`;

            // Show modal
            document.getElementById("mapModal").style.display = "block";

            // Clear any existing map
            const mapElement = document.getElementById("map");
            mapElement.innerHTML = "";

            // Get current position
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                function (position) {
                  initMap(position, order);
                },
                function (error) {
                  console.error("Error getting location:", error);
                  alert(
                    "We need your location to show the route. Please enable location services and try again."
                  );
                }
              );
            } else {
              alert("Geolocation is not supported by this browser.");
            }
          } else {
            alert("Failed to load order details.");
          }
        } catch (error) {
          console.error("Error loading order details:", error);
          alert("Error loading order details. Please try again.");
        }
      }

      // Initialize map with routing
      let mapInstance = null; // Store the map instance globally

      function initMap(position, order) {
        const driverLatLng = [
          position.coords.latitude,
          position.coords.longitude,
        ];
        const restaurantLatLng = [
          parseFloat(order.restaurant.latitude),
          parseFloat(order.restaurant.longitude),
        ];
        const customerLatLng = [
          parseFloat(order.latitude),
          parseFloat(order.longitude),
        ];

        // If a map already exists, remove it and create a new one
        if (mapInstance) {
          mapInstance.remove();
          mapInstance = null;
        }

        // Create map centered on driver's location
        mapInstance = L.map("map").setView(driverLatLng, 13);

        // Add tile layer
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap contributors",
        }).addTo(mapInstance);

        // Add markers with custom icons and permanent labels
        // Driver marker (blue)
        const driverIcon = L.divIcon({
          className: "custom-div-icon",
          html: `<div style="background-color:#4285F4; color:white; padding:5px; border-radius:50%; text-align:center;">üöó</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15],
        });

        // Restaurant marker (red)
        const restaurantIcon = L.divIcon({
          className: "custom-div-icon",
          html: `<div style="background-color:#DB4437; color:white; padding:5px; border-radius:50%; text-align:center;">üçΩÔ∏è</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15],
        });

        // Customer marker (green)
        const customerIcon = L.divIcon({
          className: "custom-div-icon",
          html: `<div style="background-color:#0F9D58; color:white; padding:5px; border-radius:50%; text-align:center;">üìç</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15],
        });

        // Add markers with permanent tooltips
        L.marker(driverLatLng, { icon: driverIcon })
          .addTo(mapInstance)
          .bindTooltip("Your Location (Driver)", {
            permanent: true,
            direction: "top",
            offset: [0, -10],
          });

        L.marker(restaurantLatLng, { icon: restaurantIcon })
          .addTo(mapInstance)
          .bindTooltip(order.restaurant.name || "Restaurant", {
            permanent: true,
            direction: "top",
            offset: [0, -10],
          });

        L.marker(customerLatLng, { icon: customerIcon })
          .addTo(mapInstance)
          .bindTooltip("Customer", {
            permanent: true,
            direction: "top",
            offset: [0, -10],
          });

        // Try to add routing, but don't fail if routing doesn't work
        try {
          // Create a direct line between points instead of using the routing service
          // Driver to Restaurant (blue line)
          const driverToRestaurantLine = L.polyline(
            [driverLatLng, restaurantLatLng],
            {
              color: "#4285F4",
              weight: 4,
              opacity: 0.7,
            }
          ).addTo(mapInstance);

          // Restaurant to Customer (green line)
          const restaurantToCustomerLine = L.polyline(
            [restaurantLatLng, customerLatLng],
            {
              color: "#0F9D58",
              weight: 4,
              dashArray: "10, 10",
              opacity: 0.7,
            }
          ).addTo(mapInstance);

          // Add distance labels to lines
          const driverToRestaurantDistance = calculateDistance(
            driverLatLng,
            restaurantLatLng
          );
          const restaurantToCustomerDistance = calculateDistance(
            restaurantLatLng,
            customerLatLng
          );

          const midpointDR = getMidpoint(driverLatLng, restaurantLatLng);
          const midpointRC = getMidpoint(restaurantLatLng, customerLatLng);

          L.marker(midpointDR, {
            icon: L.divIcon({
              className: "distance-label",
              html: `<div style="background-color:white; padding:3px; border-radius:3px; font-size:12px;">${driverToRestaurantDistance.toFixed(
                1
              )} km</div>`,
              iconSize: [80, 20],
              iconAnchor: [40, 10],
            }),
          }).addTo(mapInstance);

          L.marker(midpointRC, {
            icon: L.divIcon({
              className: "distance-label",
              html: `<div style="background-color:white; padding:3px; border-radius:3px; font-size:12px;">${restaurantToCustomerDistance.toFixed(
                1
              )} km</div>`,
              iconSize: [80, 20],
              iconAnchor: [40, 10],
            }),
          }).addTo(mapInstance);
        } catch (error) {
          console.error("Error setting up routing:", error);
          // If routing fails completely, at least the markers are still shown
        }

        // Make sure the map is properly sized
        setTimeout(() => {
          mapInstance.invalidateSize();
          // Fit bounds to include all points
          const bounds = L.latLngBounds([
            driverLatLng,
            restaurantLatLng,
            customerLatLng,
          ]);
          mapInstance.fitBounds(bounds, { padding: [50, 50] });
        }, 100);
      }

      // Calculate distance between two points in km using the Haversine formula
      function calculateDistance(point1, point2) {
        const lat1 = point1[0];
        const lon1 = point1[1];
        const lat2 = point2[0];
        const lon2 = point2[1];

        const R = 6371; // Radius of the Earth in km
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c; // Distance in km
        return distance;
      }

      // Get midpoint between two points
      function getMidpoint(point1, point2) {
        return [(point1[0] + point2[0]) / 2, (point1[1] + point2[1]) / 2];
      }
    </script>
  </body>
</html>
