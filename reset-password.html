<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Reset Password</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="css/signin.css"
    />
    <style>
      .error-message {
        color: #ff3333;
        font-size: 14px;
        margin-top: 5px;
        text-align: left;
        display: none;
        animation: fadeIn 0.3s ease-out;
      }

      .input-group.error input {
        border-color: #ff3333;
        box-shadow: 0 0 5px rgba(255, 51, 51, 0.3);
      }

      .success-message {
        color: #28a745;
        font-size: 14px;
        margin-top: 15px;
        text-align: center;
        display: none;
        animation: fadeIn 0.3s ease-out;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <form
        class="signin-form"
        id="reset-password-form"
        onsubmit="handleSubmit(event)"
      >
        <div class="form-heading">RESET PASSWORD</div>
        <div class="input-group" id="password-group">
          <label class="label" for="password">New Password</label>
          <input
            required
            placeholder="Enter new password"
            name="password"
            id="password"
            type="password"
            minlength="8"
          />
          <div class="error-message" id="password-error"></div>
        </div>
        <div class="input-group" id="password-confirmation-group">
          <label class="label" for="password_confirmation"
            >Confirm Password</label
          >
          <input
            required
            placeholder="Confirm new password"
            name="password_confirmation"
            id="password_confirmation"
            type="password"
            minlength="8"
          />
          <div class="error-message" id="password-confirmation-error"></div>
        </div>
        <div class="success-message" id="success-message"></div>
        <button class="submit" type="submit">Reset Password</button>
        <div class="signup-link">
          Remember your password? <a href="signin.html">Sign in</a>
        </div>
      </form>
    </div>
    <script>
      const url = "https://tawseel.circleteams.com";
      // const url = "http://tawseel.test";

      // Get token and email from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");
      const email = urlParams.get("email");

      // Redirect to signin if token or email is missing
      if (!token || !email) {
        window.location.href = "signin.html";
      }

      // Function to clear error messages
      function clearErrors() {
        const errorElements = document.querySelectorAll(".error-message");
        errorElements.forEach((element) => {
          element.style.display = "none";
          element.textContent = "";
        });

        document.getElementById("password-group").classList.remove("error");
        document
          .getElementById("password-confirmation-group")
          .classList.remove("error");
        document.getElementById("success-message").style.display = "none";
      }

      // Function to show error message
      function showError(fieldId, message) {
        const errorElement = document.getElementById(fieldId + "-error");
        const inputGroup = document.getElementById(fieldId + "-group");

        if (errorElement && inputGroup) {
          errorElement.textContent = message;
          errorElement.style.display = "block";
          inputGroup.classList.add("error");
        }
      }

      // Function to show success message
      function showSuccess(message) {
        const successElement = document.getElementById("success-message");
        if (successElement) {
          successElement.textContent = message;
          successElement.style.display = "block";
        }
      }

      async function handleSubmit(event) {
        event.preventDefault();
        clearErrors(); // Clear any previous errors

        const password = document.getElementById("password").value;
        const password_confirmation = document.getElementById(
          "password_confirmation"
        ).value;
        const submitButton = document.querySelector(".submit");

        // Check if passwords match
        if (password !== password_confirmation) {
          showError("password-confirmation", "Passwords do not match");
          return;
        }

        // Disable button during API call
        submitButton.disabled = true;
        submitButton.textContent = "Resetting...";

        try {
          const response = await fetch(url + "/api/reset-password", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({
              email,
              token,
              password,
              password_confirmation,
            }),
          });

          // Re-enable button
          submitButton.disabled = false;
          submitButton.textContent = "Reset Password";

          if (response.ok) {
            // Clear the form
            document.getElementById("reset-password-form").reset();

            // Show success message
            showSuccess(
              "Your password has been reset successfully. Redirecting to login page..."
            );

            // Redirect to login page after 3 seconds
            setTimeout(() => {
              window.location.href = "signin.html";
            }, 3000);
          } else {
            // Try to get more specific error message from response
            try {
              const errorData = await response.json();
              if (errorData.message) {
                if (errorData.errors && errorData.errors.password) {
                  showError("password", errorData.errors.password[0]);
                } else {
                  showError("password", errorData.message);
                }
              } else {
                showError(
                  "password",
                  "Failed to reset password. Please try again."
                );
              }
            } catch (e) {
              showError(
                "password",
                "Failed to reset password. Please try again."
              );
            }
          }
        } catch (error) {
          // Re-enable button
          submitButton.disabled = false;
          submitButton.textContent = "Reset Password";

          console.error("Error:", error);
          showError("password", "An error occurred. Please try again later.");
        }
      }
    </script>
  </body>
</html>
