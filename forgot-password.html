<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Forgot Password</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="css/signin.css"
    />
    <style>
      .error-message {
        color: #ff3333;
        font-size: 14px;
        margin-top: 5px;
        text-align: left;
        display: none;
        animation: fadeIn 0.3s ease-out;
      }

      .input-group.error input {
        border-color: #ff3333;
        box-shadow: 0 0 5px rgba(255, 51, 51, 0.3);
      }

      .success-message {
        color: #28a745;
        font-size: 14px;
        margin-top: 15px;
        text-align: center;
        display: none;
        animation: fadeIn 0.3s ease-out;
      }
      
      .code-sent {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <form
        class="signin-form"
        id="forgot-password-form"
        onsubmit="handleSubmit(event)"
      >
        <div class="form-heading">FORGOT PASSWORD</div>
        <p style="text-align: center; color: #fff; margin-bottom: 20px">
          Enter your email address and we'll send you a verification code to reset your
          password.
        </p>
        <div class="input-group" id="email-group">
          <label class="label" for="email">Email</label>
          <input
            required
            placeholder="Enter your email"
            name="email"
            id="email"
            type="email"
          />
          <div class="error-message" id="email-error"></div>
        </div>
        <div class="input-group code-sent" id="code-group">
          <label class="label" for="code">Verification Code</label>
          <input
            placeholder="Enter verification code"
            name="code"
            id="code"
            type="text"
          />
          <div class="error-message" id="code-error"></div>
        </div>
        <div class="success-message" id="success-message"></div>
        <button class="submit" type="submit" id="submit-button">Send Verification Code</button>
        <div class="signup-link">
          Remember your password? <a href="signin.html">Sign in</a>
        </div>
      </form>
    </div>
    <script>
        const url = "https://tawseel.circleteams.com";
      // const url = "http://tawseel.test";

      let codeSent = false;
      let userEmail = "";

      // Function to clear error messages
      function clearErrors() {
        const errorElements = document.querySelectorAll(".error-message");
        errorElements.forEach((element) => {
          element.style.display = "none";
          element.textContent = "";
        });

        document.getElementById("email-group").classList.remove("error");
        if (document.getElementById("code-group")) {
          document.getElementById("code-group").classList.remove("error");
        }
        document.getElementById("success-message").style.display = "none";
      }

      // Function to show error message
      function showError(fieldId, message) {
        const errorElement = document.getElementById(fieldId + "-error");
        const inputGroup = document.getElementById(fieldId + "-group");

        if (errorElement && inputGroup) {
          errorElement.textContent = message;
          errorElement.style.display = "block";
          inputGroup.classList.add("error");
        }
      }

      // Function to show success message
      function showSuccess(message) {
        const successElement = document.getElementById("success-message");
        if (successElement) {
          successElement.textContent = message;
          successElement.style.display = "block";
        }
      }

      async function handleSubmit(event) {
        event.preventDefault();
        clearErrors(); // Clear any previous errors

        const email = document.getElementById("email").value;
        const submitButton = document.getElementById("submit-button");
        
        if (!codeSent) {
          // First step: Request verification code
          userEmail = email;
          
          // Disable button during API call
          submitButton.disabled = true;
          submitButton.textContent = "Sending...";

          try {
            const response = await fetch(url + "/api/forgot-password", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ email }),
            });

            // Re-enable button
            submitButton.disabled = false;

            if (response.ok) {
              // Show code input field
              document.getElementById("code-group").style.display = "block";
              document.getElementById("email").readOnly = true;
              
              // Update button text
              submitButton.textContent = "Reset Password";
              
              // Show success message
              showSuccess(
                "Verification code has been sent to your email. Please check your inbox."
              );
              
              // Update state
              codeSent = true;
            } else {
              // Handle different error status codes
              if (response.status === 404) {
                showError(
                  "email",
                  "Email not found. Please check your email address."
                );
              } else {
                // Try to get more specific error message from response
                try {
                  const errorData = await response.json();
                  if (errorData.message) {
                    showError("email", errorData.message);
                  } else {
                    showError(
                      "email",
                      "Failed to send verification code. Please try again."
                    );
                  }
                } catch (e) {
                  showError(
                    "email",
                    "Failed to send verification code. Please try again."
                  );
                }
              }
            }
          } catch (error) {
            // Re-enable button
            submitButton.disabled = false;
            submitButton.textContent = "Send Verification Code";

            console.error("Error:", error);
            showError("email", "An error occurred. Please try again later.");
          }
        } else {
          // Second step: Verify code and redirect to reset password
          const code = document.getElementById("code").value;
          
          if (!code) {
            showError("code", "Please enter the verification code");
            return;
          }
          
          // Disable button during API call
          submitButton.disabled = true;
          submitButton.textContent = "Verifying...";

          try {
            const response = await fetch(url + "/api/verify-reset-code", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ email: userEmail, code }),
            });

            // Re-enable button
            submitButton.disabled = false;
            submitButton.textContent = "Reset Password";

            if (response.ok) {
              const data = await response.json();
              // Redirect to reset password page with token
              window.location.href = `reset-password.html?email=${encodeURIComponent(userEmail)}&token=${encodeURIComponent(data.token)}`;
            } else {
              // Try to get more specific error message from response
              try {
                const errorData = await response.json();
                if (errorData.message) {
                  showError("code", errorData.message);
                } else {
                  showError(
                    "code",
                    "Invalid verification code. Please try again."
                  );
                }
              } catch (e) {
                showError(
                  "code",
                  "Invalid verification code. Please try again."
                );
              }
            }
          } catch (error) {
            // Re-enable button
            submitButton.disabled = false;
            submitButton.textContent = "Reset Password";

            console.error("Error:", error);
            showError("code", "An error occurred. Please try again later.");
          }
        }
      }
    </script>
  </body>
</html>
